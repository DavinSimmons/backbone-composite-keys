// Generated by CoffeeScript 1.3.3
(function() {
  var bind, _;

  _ = this._ || require('underscore');

  (typeof module !== "undefined" && module !== null ? module : {}).exports = bind = function(Backbone) {
    var generateId, set, _onModelEvent;
    set = Backbone.Model.prototype.set;
    generateId = function(idAttr, attrs) {
      var index, indexes, val, _i, _len;
      if (typeof idAttr === 'string') {
        return attrs[idAttr];
      }
      indexes = [];
      for (_i = 0, _len = idAttr.length; _i < _len; _i++) {
        index = idAttr[_i];
        if (!(val = attrs[index])) {
          return void 0;
        }
        indexes.push(val);
      }
      return indexes.join('-');
    };
    _.extend(Backbone.Model.prototype, {
      _generateId: function(attrs) {
        if (attrs == null) {
          attrs = this.attributes;
        }
        return generateId(this.idAttribute, attrs);
      },
      set: function(key, val, options) {
        var attrs;
        if (key == null) {
          return this;
        }
        if (_.isObject(key)) {
          attrs = key;
          options = val;
        } else {
          (attrs = {})[key] = val;
        }
        if (!this._validate(attrs, options || {})) {
          return false;
        }
        this._previousId = this.id;
        this.id = this._generateId(_.extend({}, this.attributes, attrs));
        return set.apply(this, arguments);
      }
    });
    _onModelEvent = Backbone.Collection.prototype._onModelEvent;
    _.extend(Backbone.Collection.prototype, {
      get: function(obj) {
        if (obj == null) {
          return void 0;
        }
        this._idAttr || (this._idAttr = this.model.prototype.idAttribute);
        return this._byId[obj.id || obj.cid || generateId(this._idAttr, obj) || obj];
      },
      _onModelEvent: function(event, model, collection, options) {
        if (model && event === 'change' && model.id !== model._previousId) {
          delete this._byId[model._previousId];
          if (model.id != null) {
            this._byId[model.id] = model;
          }
        }
        return _onModelEvent.apply(this, arguments);
      }
    });
    return Backbone;
  };

  if (this.Backbone) {
    bind(Backbone);
  }

}).call(this);
